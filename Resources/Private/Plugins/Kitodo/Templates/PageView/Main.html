<f:comment>
    Copyright notice

    (c) Saxon State and University Library Dresden <typo3@slub-dresden.de>
    All rights reserved

    This script is part of the TYPO3 project. The TYPO3 project is
    free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 3 of the License, or
    (at your option) any later version.

    The GNU General Public License can be found at
    http://www.gnu.org/copyleft/gpl.html.

    This script is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    This copyright notice MUST APPEAR in all copies of the script!
</f:comment>

<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:kitodo="http://typo3.org/ns/Kitodo/Dlf/ViewHelpers"
      data-namespace-typo3-fluid="true">

<f:if condition="{multiview} == 1">
    <f:then>
       <div class="page-control-multiview">
            <div class="backs">
                <span class="prev">
                    <a href="#" data-page-control-selector=".backs .prev a"><f:translate key="prevPage" /></a>
                </span>
            </div>
            <div class="measureBacks">
                <span class="prev">
                    <a href="#" data-page-control-selector=".measureBacks .next a"><f:translate key="prevMeasure" /></a>
                </span>
            </div>
            <div class="fwds">
                <span class="next">
                    <a href="#" data-page-control-selector=".fwds .next a"><f:translate key="nextPage" /></a>
                </span>
            </div>
            <div class="measureFwds">
                <span class="next">
                    <a href="#" data-page-control-selector=".measureFwds .next a" ></f:translate key="nextMeasure" /></a>
                </span>
            </div>
        </div>
        <div class="grid-stack-wrapper">
            <div class="grid-stack">
                <f:for each="{multiViewDocuments}" as="document" iteration="iterator" >
                    <div class="grid-stack-item" gs-w="6" gs-h="6" gs-id="{iterator.index}" >
                        <div class="grid-stack-item-content" style="overflow: hidden">
                            <iframe src="/viewer?tx_dlf%5Bid%5D={document.encodedUrl}&tx_dlf%5Bpage%5D={document.page}&tx_dlf%5Bmultiviewembedded%5D=1" width="100%" height="100%" style="overflow: hidden;" ></iframe>
                        </div>
                        <div class="gridstack-dragging-handle" title="{f:translate(key: 'multiview.dragging_label', extensionName: 'dfgviewer')}"></div>
                        <f:if condition="{document.sourceKey} >= 0">
                            <div class="removeDocument">
                                <f:link.action addQueryString="untrusted" argumentsToBeExcludedFromQueryString="{0: 'tx_dlf[multiViewSource][{document.sourceKey}]', 1: 'tx_dlf[multiview]'}">
                                    <f:translate key="multiview.remove_document" extensionName="dfgviewer" />
                                </f:link.action>
                            </div>
                        </f:if>
                    </div>
                </f:for>
            </div>
        </div>
        <script>
            const iframes = document.querySelectorAll('.grid-stack iframe');
            const multiviewControls = document.querySelectorAll(".page-control-multiview a");

            multiviewControls.forEach(multiviewControl => {
                multiviewControl.addEventListener("click", function (event) {
                    event.preventDefault(); // stops navigation
                    const clicked = event.currentTarget;

                    const loadedIframes = Array.from(document.querySelectorAll('.grid-stack iframe')).filter(iframe => {
                        try {
                            // Accessing contentDocument throws an error if cross-origin
                            return iframe.contentDocument && iframe.contentDocument.readyState === 'complete';
                        } catch (e) {
                            return false;
                        }
                    });

                    loadedIframes.forEach(iframe => {
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const pageControl = iframeDoc.querySelector('.page-control ' + clicked.dataset.pageControlSelector);
                        if(pageControl) {
                            pageControl.click();
                        }
                    });

                    iframes.forEach(iframe => {
                        iframe.addEventListener('load', () => {
                            console.log('Iframe loaded:', iframe.src);
                        });
                    });

                });
            });
        </script>
    </f:then>
    <f:else>
        <div id="tx-dfgviewer-map-0" class="tx-dlf-map"></div>
        <div class="score-container">
            <div id="tx-dlf-score-0"></div>
        </div>
        <kitodo:jsFooter inlineCode="{viewerConfiguration}" />
    </f:else>
</f:if>
</html>
